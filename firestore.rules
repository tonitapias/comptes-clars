rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Funció d'ajuda per saber si l'usuari està autenticat
    function isAuthenticated() {
      return request.auth != null;
    }

    // [MILLORA]: Fem servir el comodí {appId} perquè funcioni en qualsevol entorn
    match /artifacts/{appId}/public/data/trips/{tripId} {
      
      function isTripMember() {
        return isAuthenticated() && request.auth.uid in resource.data.memberUids;
      }
      
      // REGLES DEL DOCUMENT DEL VIATGE PRINCIPAL
      allow create: if isAuthenticated();
      allow read: if isAuthenticated();
      allow update: if isTripMember() ||
        (isAuthenticated() && request.auth.uid in request.resource.data.memberUids);
      allow delete: if isTripMember();

      // Funció compartida per a totes les subcol·leccions
      function isParentTripMember() {
        // Obtenim el document pare utilitzant els comodins actuals
        let tripDoc = get(/databases/$(database)/documents/artifacts/$(appId)/public/data/trips/$(tripId));
        return isAuthenticated() && request.auth.uid in tripDoc.data.memberUids;
      }

      // [NOVA ARQUITECTURA]: Autoritzem explícitament totes les subcol·leccions
      
      match /expenses/{expenseId} {
        allow read, write: if isParentTripMember();
      }
      
      match /payments/{paymentId} {
        allow read, write: if isParentTripMember();
      }
      
      match /logs/{logId} {
        allow read, write: if isParentTripMember();
      }
    }

    // Per defecte, deneguem TOTES les altres lectures a la base de dades
    match /{document=**} {
      allow read, write: if false;
    }
  }
}