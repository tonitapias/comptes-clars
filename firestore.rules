rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    function isAuthenticated() {
      return request.auth != null;
    }

    match /artifacts/{appId}/public/data/trips/{tripId} {
      
      function isTripMemberBefore() {
        return isAuthenticated() && request.auth.uid in resource.data.memberUids;
      }
      
      // REGLES DEL DOCUMENT PRINCIPAL
      allow create: if isAuthenticated();
      allow read: if isAuthenticated();
      allow update: if isTripMemberBefore() ||
        (isAuthenticated() && request.auth.uid in request.resource.data.memberUids);
      allow delete: if isTripMemberBefore();

      // [FIX DEFINITIU]: Comprovem si l'usuari és membre ARA MATEIX (get) 
      // o si ho serà DESPRÉS de l'operació (getAfter). 
      // Això permet transaccions atòmiques tant per UNIR-SE com per SORTIR.
      function isParentTripMember() {
        let docPath = /databases/$(database)/documents/artifacts/$(appId)/public/data/trips/$(tripId);
        
        let isMemberBefore = get(docPath) != null && request.auth.uid in get(docPath).data.memberUids;
        let isMemberAfter = getAfter(docPath) != null && request.auth.uid in getAfter(docPath).data.memberUids;
        
        return isAuthenticated() && (isMemberBefore || isMemberAfter);
      }

      // Autoritzem les subcol·leccions
      match /expenses/{expenseId} {
        allow read, write: if isParentTripMember();
      }
      
      match /payments/{paymentId} {
        allow read, write: if isParentTripMember();
      }
      
      match /logs/{logId} {
        allow read, write: if isParentTripMember();
      }
    }

    match /{document=**} {
      allow read, write: if false;
    }
  }
}